<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.9.1"/>
<title>COOLFluiD: cf3/common/PE/CommPattern.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="coolfluid.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">COOLFluiD
   &#160;<span id="projectnumber">Release  kernel</span>
   </div>
   <div id="projectbrief">COOLFluiD is a Collaborative Simulation Environment (CSE) focused on complex MultiPhysics simulations.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.9.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_1a2068f198ac163e753692de222d86be.html">cf3</a></li><li class="navelem"><a class="el" href="dir_baaf22844f7bc0d50ea638aebbc64782.html">common</a></li><li class="navelem"><a class="el" href="dir_c502f971b5303c827072e2657c1a94b5.html">PE</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">CommPattern.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="_comm_pattern_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">// Copyright (C) 2010-2013 von Karman Institute for Fluid Dynamics, Belgium</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">// This software is distributed under the terms of the</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// GNU Lesser General Public License version 3 (LGPLv3).</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">// See doc/lgpl.txt and doc/gpl.txt for the license text.</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="preprocessor">#include &quot;boost/lexical_cast.hpp&quot;</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_boost_assertions_8hpp.html">common/BoostAssertions.hpp</a>&quot;</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_lib_common_8hpp.html">common/LibCommon.hpp</a>&quot;</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_find_components_8hpp.html">common/FindComponents.hpp</a>&quot;</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_builder_8hpp.html">common/Builder.hpp</a>&quot;</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_log_8hpp.html">common/Log.hpp</a>&quot;</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_comm_8hpp.html">common/PE/Comm.hpp</a>&quot;</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_comm_pattern_8hpp.html">common/PE/CommPattern.hpp</a>&quot;</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_comm_wrapper_8hpp.html">common/PE/CommWrapper.hpp</a>&quot;</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="debug_8hpp.html">common/PE/debug.hpp</a>&quot;</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment">TODO:</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment">1.: remove boost.mpi deps when pe ready</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment">2.: if 1. is done, remove &amp;xxx[0] accessses</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="keyword">namespace </span><a class="code" href="namespacecf3.html">cf3</a> {</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="keyword">namespace </span>common  {</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="keyword">namespace </span>PE {</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="comment">// Provider</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;common::ComponentBuilder &lt; CommPattern, Component, LibCommon &gt; CommPattern_Provider;</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="comment">// Constructor &amp; destructor</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<a class="code" href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#af8d3e3e8d930cffe932453524a407707">CommPattern::CommPattern</a>(<span class="keyword">const</span> std::string&amp; <a class="code" href="namespacecf3_1_1python.html#a67907f0a2a4e9a684772d2d7b165a5ae">name</a>): Component(name), m_gid(<a class="code" href="namespacecf3_1_1common.html#a9e2779a644fde7b30a3a14b0775a66fe">allocate_component</a>&lt; CommWrapperPtr&lt;int&gt; &gt;(<span class="stringliteral">&quot;dummy&quot;</span>)),</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;  m_isUpdatable(0),</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;  m_add_buffer(0),</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;  m_mov_buffer(0),</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;  m_rem_buffer(0),</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;  m_free_lids(1,0),</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;  m_sendCount(PE::Comm::instance().size(),0),</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;  m_sendMap(0),</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;  m_recvCount(PE::Comm::instance().size(),0),</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;  m_recvMap(0)</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;{</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;  <span class="comment">//self-&gt;regist_signal ( &quot;update&quot; , &quot;Executes communication patterns on all the registered data.&quot;, &quot;&quot; ).connect ( boost::bind ( &amp;CommPattern2::update, self, _1 ) );</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;  m_isUpToDate=<span class="keyword">false</span>;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;  m_isFreeze=<span class="keyword">false</span>;</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;}</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<a class="code" href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#aedbe1f2fe33f04a1beb89d474327c078">CommPattern::~CommPattern</a>()</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;{</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#aebe049d4c5f8ea80a77a9dd52a1ac311">m_gid</a>.get()!=<span class="keyword">nullptr</span>) <a class="code" href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#aebe049d4c5f8ea80a77a9dd52a1ac311">m_gid</a>-&gt;remove_tag(<span class="stringliteral">&quot;gid_of_&quot;</span>+this-&gt;name());</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;}</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="comment">// Commpattern handling</span></div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="keywordtype">void</span> <a class="code" href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#a4fc01d736fe50cf5b977f755b675f11d">CommPattern::setup</a>(<span class="keyword">const</span> Handle&lt;CommWrapper&gt;&amp; gid, std::vector&lt;Uint&gt;&amp; rank)</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;{</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;<span class="comment">//PECheckPoint(100,&quot;-- Setup input via std::vector: (gid|rank) -- &quot; + uri().path());</span></div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="comment">//PEProcessSortedExecute(-1,</span></div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="comment">//  std::cout &lt;&lt; &quot;gid size: &quot; &lt;&lt; gid-&gt;size() &lt;&lt; &quot; rank size: &quot; &lt;&lt; rank.size() &lt;&lt; &quot;\n&quot; &lt;&lt; std::flush;</span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="comment">//  Uint* testgid=(Uint*)gid-&gt;pack();</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;<span class="comment">//  for (int i=0; i&lt;(const int)rank.size(); i++)</span></div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;<span class="comment">//    std::cout &lt;&lt; &quot;(&quot; &lt;&lt; testgid[i] &lt;&lt; &quot;|&quot; &lt;&lt; rank[i] &lt;&lt; &quot;)&quot; &lt;&lt; std::flush;</span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="comment">//  std::cout &lt;&lt; &quot;\n&quot; &lt;&lt; std::flush;</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="comment">//  delete[] testgid;</span></div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;<span class="comment">//);</span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;  <a class="code" href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#a9a1ac3099ec7e8ef3765db67153c8969">m_ranks</a>.assign(rank.begin(), rank.end());</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;  <span class="comment">// basic check</span></div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;  BOOST_ASSERT( (<a class="code" href="namespacecf3.html#a4840c4503b7d10cea5e08416eb3716f1">Uint</a>)gid-&gt;size() == rank.size() );</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;  <span class="keywordflow">if</span> (gid-&gt;stride()!=1) <span class="keywordflow">throw</span> <a class="code" href="structcf3_1_1common_1_1_bad_value.html">cf3::common::BadValue</a>(<a class="code" href="_code_location_8hpp.html#acc1ba5f90e834dec77544016b6b5619d">FromHere</a>(),<span class="stringliteral">&quot;Data to be registered as gid is not of stride=1.&quot;</span>);</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;  <span class="keywordflow">if</span> (gid-&gt;is_data_type_Uint()!=<span class="keyword">true</span>) <span class="keywordflow">throw</span> <a class="code" href="structcf3_1_1common_1_1_casting_failed.html">cf3::common::CastingFailed</a>(<a class="code" href="_code_location_8hpp.html#acc1ba5f90e834dec77544016b6b5619d">FromHere</a>(),<span class="stringliteral">&quot;Data to be registered as gid is not of type Uint.&quot;</span>);</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;  <a class="code" href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#aebe049d4c5f8ea80a77a9dd52a1ac311">m_gid</a>=<a class="code" href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#a2ae90dcd92e4a1c700dbdd10b78021f5">gid</a>;</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;  <a class="code" href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#aebe049d4c5f8ea80a77a9dd52a1ac311">m_gid</a>-&gt;add_tag(<span class="stringliteral">&quot;gid_of_&quot;</span>+this-&gt;<a class="code" href="classcf3_1_1common_1_1_component.html#a324e8c54c4c5161913681a1a52fef959">name</a>());</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<span class="comment">//  if (get_child_ptr(gid-&gt;name()).get() == nullptr) add_component(gid);</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;  <span class="comment">// sizesof datas matching</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;  BOOST_FOREACH( CommWrapper&amp; pobj, find_components_recursively&lt;CommWrapper&gt;(*<span class="keyword">this</span>) )</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    if ((<a class="code" href="namespacecf3.html#a4840c4503b7d10cea5e08416eb3716f1">Uint</a>) pobj.size()!=<a class="code" href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#a982606de355f2bc9ffd987fcb317276e">m_isUpdatable</a>.size()+gid-&gt;size())</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;      throw <a class="code" href="namespacecf3.html">cf3</a>::common::BadValue(<a class="code" href="_code_location_8hpp.html#acc1ba5f90e834dec77544016b6b5619d">FromHere</a>(),&quot;Size does not match commpattern&#39;s size.&quot;);</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;  <span class="comment">// add to add buffer</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;  <span class="comment">// if performance issues, replace for(...) add_global(...) with direct push_back</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;  <span class="comment">//if (gid-&gt;size()!=0)</span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;  <span class="comment">//{</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    <a class="code" href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#acf08aef8ff8a70c632af627dc381777c">m_isUpToDate</a>=false;</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    <a class="code" href="namespacestd.html">std</a>::vector&lt;<span class="keywordtype">int</span>&gt; <a class="code" href="utest-mesh-dictionary_8cpp.html#a9f6c37b0b11a193703cacdeb5c3e3f6b">map</a>(gid-&gt;size());</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    for(<span class="keywordtype">int</span> i=0; i&lt;(const <span class="keywordtype">int</span>)<a class="code" href="utest-mesh-dictionary_8cpp.html#a9f6c37b0b11a193703cacdeb5c3e3f6b">map</a>.size(); i++) <a class="code" href="utest-mesh-dictionary_8cpp.html#a9f6c37b0b11a193703cacdeb5c3e3f6b">map</a>[i]=i;</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    PE::CommWrapperView&lt;<a class="code" href="namespacecf3.html#a4840c4503b7d10cea5e08416eb3716f1">Uint</a>&gt; cwv_gid(<a class="code" href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#aebe049d4c5f8ea80a77a9dd52a1ac311">m_gid</a>);</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    <a class="code" href="namespacestd.html">std</a>::vector&lt;<a class="code" href="namespacecf3.html#a4840c4503b7d10cea5e08416eb3716f1">Uint</a>&gt;::<a class="code" href="classcf3_1_1common_1_1_component.html#ac54e76afbf245efdd30b205dcb940f8a">iterator</a> irank=rank.<a class="code" href="classcf3_1_1common_1_1_component.html#a7a36979ddbbee784d3add3d8f518b9f2">begin</a>();</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    for (<a class="code" href="namespacecf3.html#a4840c4503b7d10cea5e08416eb3716f1">Uint</a>* iigid=cwv_gid();irank!=rank.<a class="code" href="classcf3_1_1common_1_1_component.html#a9ce1915506b54e15a31a46b6cc8f6368">end</a>();irank++,iigid++)</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;      <a class="code" href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#a560cabf21c45c048c4af07f20ccdf8f2">add_global</a>(*iigid,*irank);</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="comment">//PECheckPoint(100,&quot;-- Setup comission: (gid|rank|lid|option)--&quot;);</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="comment">//PEProcessSortedExecute(-1,</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;<span class="comment">//  BOOST_FOREACH(temp_buffer_item&amp; i, m_add_buffer) std::cout &lt;&lt; &quot;(&quot;&lt;&lt; i.gid &lt;&lt; &quot;|&quot; &lt;&lt; i.rank &lt;&lt; &quot;|&quot; &lt;&lt; i.lid &lt;&lt; &quot;|&quot; &lt;&lt; i.option &lt;&lt; &quot;)&quot;;</span></div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;<span class="comment">//  std::cout &lt;&lt; &quot;\n&quot; &lt;&lt; std::flush;</span></div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;<span class="comment">//)</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    gid-&gt;resize(0);</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    <a class="code" href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#a982606de355f2bc9ffd987fcb317276e">m_isUpdatable</a>.resize(0);</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    <a class="code" href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#a1541d04226428ccf0b5bf9741b31aa8e">m_free_lids</a>.resize(1);</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    <a class="code" href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#a4fc01d736fe50cf5b977f755b675f11d">setup</a>();</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;  <span class="comment">//}</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;}</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;<span class="keywordtype">void</span> <a class="code" href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#af8d3e3e8d930cffe932453524a407707">CommPattern</a>::<a class="code" href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#a4fc01d736fe50cf5b977f755b675f11d">setup</a>(const Handle&lt;CommWrapper&gt;&amp; gid, <a class="code" href="namespaceboost.html">boost</a>::multi_array&lt;<a class="code" href="namespacecf3.html#a4840c4503b7d10cea5e08416eb3716f1">Uint</a>,1&gt;&amp; rank)</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;{</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="comment">//PECheckPoint(100,&quot;-- Setup input via multiarray: (gid|rank) -- &quot; + uri().path());</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;<span class="comment">//PEProcessSortedExecute(-1,</span></div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;<span class="comment">//  std::cout &lt;&lt; &quot;gid size: &quot; &lt;&lt; gid-&gt;size() &lt;&lt; &quot; rank size: &quot; &lt;&lt; rank.size() &lt;&lt; &quot;\n&quot; &lt;&lt; std::flush;</span></div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;<span class="comment">//  Uint* testgid=(Uint*)gid-&gt;pack();</span></div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;<span class="comment">//  for (int i=0; i&lt;(const int)rank.size(); i++)</span></div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="comment">//    std::cout &lt;&lt; &quot;(&quot; &lt;&lt; testgid[i] &lt;&lt; &quot;|&quot; &lt;&lt; rank[i] &lt;&lt; &quot;)&quot; &lt;&lt; std::flush;</span></div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;<span class="comment">//  std::cout &lt;&lt; &quot;\n&quot; &lt;&lt; std::flush;</span></div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;<span class="comment">//  delete[] testgid;</span></div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;<span class="comment">//);</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;  <a class="code" href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#a9a1ac3099ec7e8ef3765db67153c8969">m_ranks</a>.assign(rank.begin(), rank.end());</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;  <span class="comment">// basic check</span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;  BOOST_ASSERT( (Uint)gid-&gt;size() == rank.size() );</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;  <span class="keywordflow">if</span> (gid-&gt;stride()!=1) <span class="keywordflow">throw</span> <a class="code" href="structcf3_1_1common_1_1_bad_value.html">cf3::common::BadValue</a>(<a class="code" href="_code_location_8hpp.html#acc1ba5f90e834dec77544016b6b5619d">FromHere</a>(),<span class="stringliteral">&quot;Data to be registered as gid is not of stride=1.&quot;</span>);</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;  <span class="keywordflow">if</span> (gid-&gt;is_data_type_Uint()!=<span class="keyword">true</span>) <span class="keywordflow">throw</span> <a class="code" href="structcf3_1_1common_1_1_casting_failed.html">cf3::common::CastingFailed</a>(<a class="code" href="_code_location_8hpp.html#acc1ba5f90e834dec77544016b6b5619d">FromHere</a>(),<span class="stringliteral">&quot;Data to be registered as gid is not of type Uint.&quot;</span>);</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;  m_gid=<a class="code" href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#a2ae90dcd92e4a1c700dbdd10b78021f5">gid</a>;</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;  m_gid-&gt;add_tag(<span class="stringliteral">&quot;gid_of_&quot;</span>+this-&gt;<a class="code" href="classcf3_1_1common_1_1_component.html#a324e8c54c4c5161913681a1a52fef959">name</a>());</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;<span class="comment">//  if (get_child_ptr(gid-&gt;name()).get() == nullptr) add_component(gid);</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;  <span class="comment">// sizesof datas matching</span></div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;  BOOST_FOREACH( CommWrapper&amp; pobj, find_components_recursively&lt;CommWrapper&gt;(*<span class="keyword">this</span>) )</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;    if ((Uint) pobj.size()!=<a class="code" href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#a982606de355f2bc9ffd987fcb317276e">m_isUpdatable</a>.size()+gid-&gt;size())</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;      throw <a class="code" href="namespacecf3.html">cf3</a>::common::BadValue(FromHere(),&quot;Size does not match commpattern&#39;s size.&quot;);</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;  <span class="comment">// add to add buffer</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;  <span class="comment">// if performance issues, replace for(...) add_global(...) with direct push_back</span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;  if (gid-&gt;size()!=0) {</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    <a class="code" href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#acf08aef8ff8a70c632af627dc381777c">m_isUpToDate</a>=<span class="keyword">false</span>;</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    std::vector&lt;int&gt; <a class="code" href="utest-mesh-dictionary_8cpp.html#a9f6c37b0b11a193703cacdeb5c3e3f6b">map</a>(gid-&gt;size());</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;(int)<a class="code" href="utest-mesh-dictionary_8cpp.html#a9f6c37b0b11a193703cacdeb5c3e3f6b">map</a>.size(); i++) <a class="code" href="utest-mesh-dictionary_8cpp.html#a9f6c37b0b11a193703cacdeb5c3e3f6b">map</a>[i]=i;</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    PE::CommWrapperView&lt;Uint&gt; cwv_gid(m_gid);</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    boost::multi_array&lt;Uint,1&gt;::iterator irank=rank.begin();</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    <span class="keywordflow">for</span> (Uint* iigid=cwv_gid();irank!=rank.end();irank++,iigid++)</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;      <a class="code" href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#a560cabf21c45c048c4af07f20ccdf8f2">add_global</a>(*iigid,*irank);</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;<span class="comment">//PECheckPoint(100,&quot;-- Setup comission: (gid|rank|lid|option)--&quot;);</span></div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;<span class="comment">//PEProcessSortedExecute(-1,</span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;<span class="comment">//  BOOST_FOREACH(temp_buffer_item&amp; i, m_add_buffer) std::cout &lt;&lt; &quot;(&quot;&lt;&lt; i.gid &lt;&lt; &quot;|&quot; &lt;&lt; i.rank &lt;&lt; &quot;|&quot; &lt;&lt; i.lid &lt;&lt; &quot;|&quot; &lt;&lt; i.option &lt;&lt; &quot;)&quot;;</span></div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;<span class="comment">//  std::cout &lt;&lt; &quot;\n&quot; &lt;&lt; std::flush;</span></div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;<span class="comment">//)</span></div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    gid-&gt;resize(0);</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    <a class="code" href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#a982606de355f2bc9ffd987fcb317276e">m_isUpdatable</a>.resize(0);</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    <a class="code" href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#a1541d04226428ccf0b5bf9741b31aa8e">m_free_lids</a>.resize(1);</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    <a class="code" href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#a4fc01d736fe50cf5b977f755b675f11d">setup</a>();</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;  }</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;}</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;<span class="comment">void CommPattern::setup()</span></div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;<span class="comment">{</span></div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;<span class="comment">#define COMPUTE_IRANK(inode,nproc,nnode) ((((unsigned long long)(inode))*((unsigned long long)(nproc)))/((unsigned long long)(nnode)))</span></div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;<span class="comment">#define COMPUTE_INODE(irank,nproc,nnode) (((unsigned long long)(nnode))&gt;((unsigned long long)(nproc)) ? ((((unsigned long long)(irank))*((unsigned long long)(nnode)))%((unsigned long long)(nproc))==0?(((unsigned long long)(irank))*((unsigned long long)(nnode)))/((unsigned long long)(nproc)):((((unsigned long long)(irank))*((unsigned long long)(nnode)))/((unsigned long long)(nproc)))+1ul) : ((unsigned long long)(irank)))</span></div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;<span class="comment">  if (m_gid==nullptr) throw common::BadValue(FromHere(),name() + &quot;: There is no gid associated to this CommPattern.&quot;);</span></div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;<span class="comment">PECheckPoint(100,&quot;001&quot;);</span></div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;<span class="comment">  // exit on obvious</span></div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;<span class="comment">  int changes[3]={0,0,0}; // order: add,mov,rem</span></div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;<span class="comment">  changes[0]=m_add_buffer.size();</span></div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<span class="comment">  changes[1]=m_mov_buffer.size();</span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;<span class="comment">  changes[2]=m_rem_buffer.size();</span></div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;<span class="comment">PECheckPoint(1000,&quot;002&quot;);</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;<span class="comment">  PE::Comm::instance().all_reduce(PE::plus(),changes,3,changes);</span></div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;<span class="comment">  if (changes[0]+changes[1]+changes[2]==0) return;</span></div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;<span class="comment">//  if (changes[1]+changes[2]==0) GOTO OPTIMIZED ADD-ONLY FUNCTION FOR PERFORMANCE</span></div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;<span class="comment">PECheckPoint(1000,&quot;003&quot;);</span></div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;<span class="comment">  // get stuff</span></div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;<span class="comment">  const CPint irank=(CPint)PE::Comm::instance().rank();</span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;<span class="comment">  const CPint nproc=(CPint)PE::Comm::instance().size();</span></div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;<span class="comment">  if (m_gid.get()==nullptr) throw cf3::common::BadValue(FromHere(),&quot;Gid is not registered for for commpattern: &quot; + name());</span></div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;<span class="comment">  if (m_gid-&gt;stride()!=1) throw cf3::common::BadValue(FromHere(),&quot;Gid is not of stride==1 for commpattern: &quot; + name());</span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;<span class="comment">  if (m_gid-&gt;is_data_type_Uint()!=true) throw cf3::common::CastingFailed(FromHere(),&quot;Gid is not of type Uint for commpattern: &quot; + name());</span></div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;<span class="comment">PECheckPoint(1000,&quot;004&quot;);</span></div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;<span class="comment">  // filling buffer to be inverted into a global, over-all-ranks array</span></div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;<span class="comment">  { // brackets necessary for gid view to live short</span></div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;<span class="comment">    PE::CommWrapperView&lt;Uint&gt; cwv_gid(m_gid);</span></div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;<span class="comment">    Uint* gid=cwv_gid();</span></div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;<span class="comment">    // filling a local vector with the existing nodes</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;<span class="comment">    std::vector&lt;dist_struct&gt; l(0);</span></div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;<span class="comment">      for(int i=0; i&lt;(const int)m_gid-&gt;size(); i++)</span></div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;<span class="comment">      {</span></div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;<span class="comment">        if (m_isUpdatable[i]) l.push_back(dist_struct(gid[i],irank,i,NOFLAGS));</span></div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;<span class="comment">        else l.push_back(dist_struct(gid[i],irank,i,GHOST));</span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;<span class="comment">      }</span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;<span class="comment">    }</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;<span class="comment">    // extending the local vector with remove info</span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;<span class="comment">    BOOST_FOREACH(temp_buffer_item i, m_rem_buffer)</span></div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;<span class="comment">    {</span></div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;<span class="comment">      if (i.option) l.push_back(dist_struct(gid[i.lid],i.rank,i.lid,ALLDELETE|DELETED));</span></div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;<span class="comment">      else l.push_back(dist_struct(gid[i.lid],i.rank,i.lid,DELETED));</span></div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;<span class="comment">    }</span></div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;<span class="comment">    // extending the local vector with inter-process move info</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;<span class="comment">    BOOST_FOREACH(temp_buffer_item i, m_mov_buffer)</span></div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;<span class="comment">    {</span></div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;<span class="comment">      l.push_back(dist_struct(gid[i.lid],i.rank,i.lid,NOFLAGS));</span></div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;<span class="comment">      if (!i.option) l.push_back(dist_struct(gid[i.lid],i.rank,i.lid,DELETED));</span></div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;<span class="comment">    }</span></div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;<span class="comment">    // extending the local vector with add info</span></div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;<span class="comment">    // 1. count the local add-s to compute needed gid counts</span></div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;<span class="comment">    // 2. organize locally distributed gids not to hook-up with global adds, its probalby a linearized loop over processes</span></div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;<span class="comment">    // 3. push to array</span></div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;<span class="comment">  } // end the scope of gid view</span></div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;<span class="comment">// OK, when the list is made:</span></div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;<span class="comment">// 1. make the global inversion,  into a receive buffer</span></div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;<span class="comment">// 2. probably here communicate the data registered to this commwrapper</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;<span class="comment">// 3. the global array should be 3 arrays:</span></div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;<span class="comment">//    - counter of dist_struct items associated to that gid</span></div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;<span class="comment">//    - pointer to hold the arrays</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;<span class="comment">//    - pointer to hold the data</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="comment">// 4. collect everything under the backbone structure designed at 3.</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="comment">// 5. do the comparisons/steps...etc associated with the flags</span></div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;<span class="comment">// 6. distribute back the results</span></div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;<span class="comment">// 7. delete interprocess leaks, add moves (will need another extra gid distribution)</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;<span class="comment">// remark 1.: make sure that the holes in the lids (can happen due to global adds and interpocess deletes) are set to ghosts and and kept in m_free_lids</span></div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;<span class="comment">// remark 2.: need a faster version when no ghost present -&gt; just needs to move data but no interprocess communication</span></div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;<span class="comment">// remark 3.: COMPUTE_IRANK (which rank a gid is in a global array) and COMPUTE_INODE (which are the starting indices on each processors) is useful for a unique, closely equally distributed elements accross all processors in a global array</span></div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;<span class="comment">#undef COMPUTE_IRANK</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;<span class="comment">#undef COMPUTE_INODE</span></div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="comment">}</span></div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;<span class="comment">/*/</span></div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;<span class="comment">void CommPattern::setup()</span></div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;<span class="comment">{</span></div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;<span class="comment">#define COMPUTE_IRANK(inode,nproc,nnode) ((((unsigned long long)(inode))*((unsigned long long)(nproc)))/((unsigned long long)(nnode)))</span></div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;<span class="comment">#define COMPUTE_INODE(irank,nproc,nnode) (((unsigned long long)(nnode))&gt;((unsigned long long)(nproc))?((((unsigned long long)(irank))*((unsigned long long)(nnode)))%((unsigned long long)(nproc))==0?(((unsigned long long)(irank))*((unsigned long long)(nnode)))/((unsigned long long)(nproc)):((((unsigned long long)(irank))*((unsigned long long)(nnode)))/((unsigned long long)(nproc)))+1ul):((unsigned long long)(irank)))</span></div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;<span class="comment">  // get stuff</span></div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;<span class="comment">  const CPint irank=(CPint)PE::Comm::instance().rank();</span></div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;<span class="comment">  const CPint nproc=(CPint)PE::Comm::instance().size();</span></div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;<span class="comment">  if (m_gid.get()==nullptr) throw cf3::common::BadValue(FromHere(),&quot;Gid is not registered for for commpattern: &quot; + name());</span></div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;<span class="comment">  if (m_gid-&gt;stride()!=1) throw cf3::common::BadValue(FromHere(),&quot;Gid is not of stride==1 for commpattern: &quot; + name());</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;<span class="comment">  if (m_gid-&gt;is_data_type_Uint()!=true) throw cf3::common::CastingFailed(FromHere(),&quot;Gid is not of type Uint for commpattern: &quot; + name());</span></div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="comment">  // look around for max gid for the global array&#39;s size</span></div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;<span class="comment">  Uint nglobalarray=0;</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;<span class="comment">  Uint maxgid_maxrank[2]={0,0};</span></div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;<span class="comment">  BOOST_FOREACH(temp_buffer_item i, m_add_buffer)</span></div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;<span class="comment">  {</span></div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;<span class="comment">    maxgid_maxrank[0]=((i.gid)&gt;(maxgid_maxrank[0]))?(i.gid):(maxgid_maxrank[0]);</span></div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;<span class="comment">    maxgid_maxrank[1]=((i.rank)&gt;(maxgid_maxrank[1]))?(i.rank):(maxgid_maxrank[1]);</span></div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;<span class="comment">  }</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;<span class="comment">  PE::Comm::instance().all_reduce(PE::max(),maxgid_maxrank,2,maxgid_maxrank);</span></div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;<span class="comment">  if (maxgid_maxrank[0]==std::numeric_limits&lt;Uint&gt;::max()) throw BadValue(FromHere(), type_name() + &quot; at &quot; + uri().path() + &quot;: invalid gid.&quot;);</span></div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="comment">  if (maxgid_maxrank[1]==std::numeric_limits&lt;Uint&gt;::max()) throw BadValue(FromHere(), type_name() + &quot; at &quot; + uri().path() + &quot;: invalid rank.&quot;);</span></div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;<span class="comment">  nglobalarray=maxgid_maxrank[0]+1; // zero based indexing!</span></div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;<span class="comment">//PEProcessSortedExecute(-1,std::cout &lt;&lt; &quot;nglobalarray= &quot; &lt;&lt; nglobalarray &lt;&lt; &quot;\n&quot; &lt;&lt; std::flush);</span></div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;<span class="comment">//PEProcessSortedExecute(-1,</span></div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;<span class="comment">//BOOST_FOREACH(temp_buffer_item&amp; i, m_add_buffer)</span></div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="comment">//  std::cout &lt;&lt;  i.lid &lt;&lt; &quot;(&quot; &lt;&lt; i.gid &lt;&lt; &quot;) &quot; &lt;&lt; std::flush;</span></div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;<span class="comment">//std::cout &lt;&lt; &quot;\n&quot; &lt;&lt; std::flush;</span></div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;<span class="comment">//);</span></div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;<span class="comment">  // fill local and its mpi communication accessories</span></div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;<span class="comment">  std::vector&lt;dist_struct&gt; local(m_add_buffer.size());</span></div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;<span class="comment">  std::vector&lt;int&gt; sendcnt(nproc,0);</span></div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;<span class="comment">  BOOST_FOREACH(temp_buffer_item&amp; i, m_add_buffer)</span></div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;<span class="comment">    sendcnt[COMPUTE_IRANK(i.gid,nproc,nglobalarray)]++;</span></div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;<span class="comment">  std::vector&lt;int&gt; sendstarts(nproc,0);</span></div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;<span class="comment">  std::vector&lt;int&gt; recvstarts(nproc,0);</span></div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;<span class="comment">  for (int i=1; i&lt;(const int)nproc; i++) sendstarts[i]=sendstarts[i-1]+sendcnt[i-1];</span></div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;<span class="comment">  BOOST_FOREACH(temp_buffer_item&amp; i, m_add_buffer)</span></div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;<span class="comment">  {</span></div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;<span class="comment">    if (i.rank==irank) local[sendstarts[COMPUTE_IRANK(i.gid,nproc,nglobalarray)]]=dist_struct(i.gid,irank,-i.lid,UPDATABLE);</span></div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;<span class="comment">    else local[sendstarts[COMPUTE_IRANK(i.gid,nproc,nglobalarray)]]=dist_struct(i.gid,irank,-i.lid,GHOST);</span></div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;<span class="comment">    sendstarts[COMPUTE_IRANK(i.gid,nproc,nglobalarray)]++;</span></div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;<span class="comment">  }</span></div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;<span class="comment">//PEProcessSortedExecute(-1, PEDebugVectorMember(local,local.size(),.rank) );</span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;<span class="comment">//PEProcessSortedExecute(-1, PEDebugVectorMember(local,local.size(),.gid) );</span></div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;<span class="comment">//PEProcessSortedExecute(-1, PEDebugVectorMember(local,local.size(),.lid) );</span></div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;<span class="comment">//PEProcessSortedExecute(-1, PEDebugVectorMember(local,local.size(),.flags) );</span></div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;<span class="comment">//PEProcessSortedExecute(-1, PEDebugVector(sendcnt,sendcnt.size()) );</span></div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;<span class="comment">//PECheckPoint(100,&quot;alltoall separator&quot;);</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;<span class="comment">  // do the all_to_all communication</span></div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;<span class="comment">  // NOTE THAT AFTER ALLTOALL, LOCAL IS THE DISTRIBUTED ONE</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;<span class="comment">  std::vector&lt;int&gt; recvcnt(nproc,-1);</span></div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="comment">  PE::Comm::instance().all_to_all(local,sendcnt,local,recvcnt);</span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;<span class="comment">//PEProcessSortedExecute(-1, PEDebugVectorMember(local,local.size(),.rank) );</span></div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;<span class="comment">//PEProcessSortedExecute(-1, PEDebugVectorMember(local,local.size(),.gid) );</span></div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;<span class="comment">//PEProcessSortedExecute(-1, PEDebugVectorMember(local,local.size(),.lid) );</span></div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;<span class="comment">//PEProcessSortedExecute(-1, PEDebugVectorMember(local,local.size(),.flags) );</span></div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;<span class="comment">//PEProcessSortedExecute(-1, PEDebugVector(recvcnt,recvcnt.size()) );</span></div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;<span class="comment">  // build up global array, first count number of elements, then allocate an old fashion dynamic 2d array (stays constant during lifetime) and fill</span></div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;<span class="comment">  // also clear local when done</span></div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;<span class="comment">  std::vector&lt;int&gt; global_nelems(COMPUTE_INODE(irank+1,nproc,nglobalarray)-COMPUTE_INODE(irank,nproc,nglobalarray),0);</span></div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;<span class="comment">  BOOST_FOREACH(dist_struct i, local) global_nelems[i.gid-COMPUTE_INODE(irank,nproc,nglobalarray)]++;</span></div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;<span class="comment">  std::vector&lt;dist_struct*&gt; global(global_nelems.size(),nullptr);</span></div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;<span class="comment">  for (int i=0; i&lt;(const int)global_nelems.size(); i++)</span></div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;<span class="comment">    if (global_nelems[i]!=0)</span></div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;<span class="comment">      global[i]=new dist_struct[global_nelems[i]];</span></div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;<span class="comment">  std::vector&lt;int&gt; entryctr(global_nelems.size(),0);</span></div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;<span class="comment">  BOOST_FOREACH(dist_struct i, local) global[i.gid-COMPUTE_INODE(irank,nproc,nglobalarray)][entryctr[i.gid-COMPUTE_INODE(irank,nproc,nglobalarray)]++]=i;</span></div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;<span class="comment">  local.clear();</span></div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;<span class="comment">  local.reserve(0);</span></div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;<span class="comment">//PEProcessSortedExecute(-1, PEDebugVector(global_nelems,global_nelems.size()) );</span></div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;<span class="comment">//PEProcessSortedExecute(-1,</span></div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;<span class="comment">//std::cout &lt;&lt; &quot;global on rank &quot; &lt;&lt; irank &lt;&lt; &quot;:\n&quot; &lt;&lt; std::flush;</span></div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;<span class="comment">//for (int i=0; i&lt;(const int)global.size(); i++) {</span></div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;<span class="comment">//  std::cout &lt;&lt; global_nelems[i] &lt;&lt; &quot;: &quot; &lt;&lt; std::flush;</span></div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;<span class="comment">//  for (int j=0; j&lt;(const int)global_nelems[i]; j++)</span></div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;<span class="comment">//    std::cout &lt;&lt; &quot;(&quot; &lt;&lt; global[i][j].gid &lt;&lt; &quot;,&quot; &lt;&lt; global[i][j].lid &lt;&lt; &quot;,&quot;&lt;&lt; global[i][j].rank &lt;&lt; &quot;,&quot; &lt;&lt; global[i][j].flags &lt;&lt; &quot;) &quot; &lt;&lt; std::flush;</span></div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;<span class="comment">//  std::cout &lt;&lt; &quot;\n&quot; &lt;&lt; std::flush;</span></div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;<span class="comment">//}</span></div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;<span class="comment">//);</span></div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;<span class="comment">//PECheckPoint(100,&quot;after globalisation&quot;);</span></div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;<span class="comment">  // do checks : holes in the gid and more then once updatable gids</span></div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;<span class="comment">  // once there, reorder that first entry is the updatable</span></div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;<span class="comment">  for (int i=0; i&lt;(const int)global.size(); i++)</span></div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;<span class="comment">  {</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;<span class="comment">    int nupdatable=0;</span></div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;<span class="comment">    for (int j=0; j&lt;(const int)global_nelems[i]; j++)</span></div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;<span class="comment">    {</span></div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;<span class="comment">      if (global[i][j].flags &amp; UPDATABLE)</span></div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;<span class="comment">      {</span></div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;<span class="comment">        nupdatable++;</span></div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;<span class="comment">        dist_struct tmp=global[i][j];</span></div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;<span class="comment">        global[i][j]=global[i][0];</span></div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;<span class="comment">        global[i][0]=tmp;</span></div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;<span class="comment">      }</span></div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;<span class="comment">    }</span></div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;<span class="comment">    if ((nupdatable==0)&amp;&amp;(global_nelems[i]!=0))</span></div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;<span class="comment">      throw common::BadValue(FromHere(), type_name() + &quot;: &quot; + uri().path() + &quot;: Error with gid &quot; + boost::lexical_cast&lt;std::string&gt;(i+COMPUTE_INODE(irank,nproc,nglobalarray)) + &quot;, it is not updatable on any of the processes.&quot; );</span></div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;<span class="comment">    if (nupdatable&gt;1)</span></div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;<span class="comment">      throw common::BadValue(FromHere(), type_name() + &quot;: &quot; + uri().path() + &quot;: Error with gid &quot; + boost::lexical_cast&lt;std::string&gt;(i+COMPUTE_INODE(irank,nproc,nglobalarray)) + &quot;, it is updatable on more than one ranks.&quot; );</span></div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;<span class="comment">  }</span></div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;<span class="comment">  // lookup information for m_recvCount, m_recvMap</span></div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;<span class="comment">  // this are really the ghost infos</span></div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;<span class="comment">  // local is pair of dist_structs storing send and receive side infos: local : { send_ghost0,recv_ghost0, send_ghost1,recv_ghost1, ...  }</span></div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;<span class="comment">  sendcnt.assign(nproc,0);</span></div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;<span class="comment">  Uint nsendback=0;</span></div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;<span class="comment">  for (int i=0; i&lt;(const int)global.size(); i++)</span></div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;<span class="comment">    for (int j=1; j&lt;(const int)global_nelems[i]; j++)</span></div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;<span class="comment">    {</span></div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;<span class="comment">      sendcnt[global[i][j].rank]++;</span></div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;<span class="comment">      nsendback++;</span></div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;<span class="comment">    }</span></div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;<span class="comment">  sendstarts.assign(nproc,0);</span></div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;<span class="comment">  local.resize(2*nsendback);</span></div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;<span class="comment">  for (int i=1; i&lt;(const int)nproc; i++) sendstarts[i]=sendstarts[i-1]+2*sendcnt[i-1];</span></div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;<span class="comment">  for (int i=0; i&lt;(const int)global.size(); i++)</span></div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;<span class="comment">    for (int j=1; j&lt;(const int)global_nelems[i]; j++)</span></div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;<span class="comment">    {</span></div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;<span class="comment">      local[sendstarts[global[i][j].rank]++]=global[i][0];</span></div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;<span class="comment">      local[sendstarts[global[i][j].rank]++]=global[i][j];</span></div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;<span class="comment">    }</span></div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;<span class="comment">  // send back ghosts</span></div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;<span class="comment">  // NOTE THAT AFTER ALLTOALL, LOCAL IS THE BACK-DISTRIBUTED GHOSTS</span></div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;<span class="comment">  recvcnt.assign(nproc,-1);</span></div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;<span class="comment">  PE::Comm::instance().all_to_all(local,sendcnt,local,recvcnt,2);</span></div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;<span class="comment">  // set up ghost communication info for all_to_all, and updatables info</span></div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;<span class="comment">  m_recvCount.assign(nproc,0);</span></div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;<span class="comment">  for(int i=0; i&lt;(const int)local.size(); i+=2) m_recvCount[local[i].rank]++;</span></div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;<span class="comment">  recvstarts.assign(nproc,0);</span></div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;<span class="comment">  for (int i=1; i&lt;(const int)nproc; i++) recvstarts[i]=recvstarts[i-1]+m_recvCount[i-1];</span></div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;<span class="comment">  m_recvMap.assign(m_recvCount[nproc-1]+recvstarts[nproc-1],-1);</span></div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;<span class="comment">  m_isUpdatable.assign(m_add_buffer.size(),true);</span></div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;<span class="comment">  for(int i=0; i&lt;(const int)local.size(); i+=2){</span></div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;<span class="comment">    m_recvMap[recvstarts[local[i].rank]++]=local[i+1].lid;</span></div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;<span class="comment">    m_isUpdatable[local[i+1].lid]=false;</span></div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;<span class="comment">  }</span></div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;<span class="comment">//PEProcessSortedExecute(-1, PEDebugVector(m_recvCount,m_recvCount.size()); );</span></div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;<span class="comment">//PEProcessSortedExecute(-1, PEDebugVector(m_recvMap,m_recvMap.size()); );</span></div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;<span class="comment">//PEProcessSortedExecute(-1, PEDebugVector(m_isUpdatable,m_isUpdatable.size()); );</span></div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;<span class="comment">  // lookup information for m_senCount, m_sendMap</span></div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;<span class="comment">  // this are really the ghost infos</span></div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;<span class="comment">  // local is pair of dist_structs storing send and receive side infos: local : { send_ghost0,recv_ghost0, send_ghost1,recv_ghost1, ...  }</span></div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;<span class="comment">  sendcnt.assign(nproc,0);</span></div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;<span class="comment">  for (int i=0; i&lt;(const int)global.size(); i++)</span></div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;<span class="comment">    for (int j=1; j&lt;(const int)global_nelems[i]; j++)</span></div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;<span class="comment">      sendcnt[global[i][0].rank]++;</span></div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;<span class="comment">  sendstarts.assign(nproc,0);</span></div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;<span class="comment">  local.resize(2*nsendback);</span></div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;<span class="comment">  for (int i=1; i&lt;(const int)nproc; i++) sendstarts[i]=sendstarts[i-1]+2*sendcnt[i-1];</span></div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;<span class="comment">  for (int i=0; i&lt;(const int)global.size(); i++)</span></div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;<span class="comment">    for (int j=1; j&lt;(const int)global_nelems[i]; j++)</span></div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;<span class="comment">    {</span></div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;<span class="comment">      local[sendstarts[global[i][0].rank]++]=global[i][0];</span></div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;<span class="comment">      local[sendstarts[global[i][0].rank]++]=global[i][j];</span></div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;<span class="comment">    }</span></div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;<span class="comment">  // send back ghosts</span></div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;<span class="comment">  // NOTE THAT AFTER ALLTOALL, LOCAL IS THE BACK-DISTRIBUTED GHOSTS</span></div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;<span class="comment">  recvcnt.assign(nproc,-1);</span></div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;<span class="comment">  PE::Comm::instance().all_to_all(local,sendcnt,local,recvcnt,2);</span></div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;<span class="comment">  // set up ghost communication info for all_to_all, and updatables info</span></div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;<span class="comment">  m_sendCount.assign(nproc,0);</span></div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;<span class="comment">  for(int i=0; i&lt;(const int)local.size(); i+=2) m_sendCount[local[i+1].rank]++;</span></div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;<span class="comment">  sendstarts.assign(nproc,0);</span></div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;<span class="comment">  for (int i=1; i&lt;(const int)nproc; i++) sendstarts[i]=sendstarts[i-1]+m_sendCount[i-1];</span></div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;<span class="comment">  m_sendMap.assign(m_sendCount[nproc-1]+sendstarts[nproc-1],-1);</span></div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;<span class="comment">  for(int i=0; i&lt;(const int)local.size(); i+=2){</span></div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;<span class="comment">    m_sendMap[sendstarts[local[i+1].rank]++]=local[i].lid;</span></div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;<span class="comment">  }</span></div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;<span class="comment">//PEProcessSortedExecute(-1, PEDebugVector(m_sendCount,m_sendCount.size()); );</span></div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;<span class="comment">//PECheckPoint(100,&quot;&quot;);</span></div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;<span class="comment">//PEProcessSortedExecute(-1, PEDebugVector(m_sendMap,m_sendMap.size()); );</span></div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;<span class="comment">//PECheckPoint(100,&quot;&quot;);</span></div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;<span class="comment">  // set gids</span></div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;<span class="comment">  m_gid-&gt;resize(m_add_buffer.size());</span></div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;<span class="comment">  CommWrapperView&lt;Uint&gt; cwv_gid(m_gid);</span></div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;<span class="comment">  Uint *gid=cwv_gid();</span></div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;<span class="comment">  BOOST_FOREACH(temp_buffer_item&amp; i, m_add_buffer) *gid++=i.gid;</span></div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;<span class="comment">  // clear stuff and reset other things</span></div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;<span class="comment">  m_isUpToDate=true;</span></div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;<span class="comment">  m_add_buffer.clear();</span></div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;<span class="comment">  m_rem_buffer.clear();</span></div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;<span class="comment">  m_mov_buffer.clear();</span></div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;<span class="comment">  m_free_lids.assign(1,m_isUpdatable.size());</span></div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;<span class="comment">  for(int i=0; i&lt;(const int)global.size(); i++)</span></div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;<span class="comment">    if (global_nelems[i]!=0)</span></div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;<span class="comment">      delete[] global[i];</span></div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;<span class="comment">#undef COMPUTE_IRANK</span></div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;<span class="comment">#undef COMPUTE_INODE</span></div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;<span class="comment">}</span></div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;<span class="comment">/**/</span></div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;<span class="comment">void CommPattern::setup()</span></div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;<span class="comment">{</span></div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;<span class="comment">  // get stuff</span></div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;<span class="comment">  const CPint irank=(CPint)PE::Comm::instance().rank();</span></div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;<span class="comment">  const CPint nproc=(CPint)PE::Comm::instance().size();</span></div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;<span class="comment">  if (m_gid.get()==nullptr) throw cf3::common::BadValue(FromHere(),&quot;Gid is not registered for for commpattern: &quot; + name());</span></div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;<span class="comment">  if (m_gid-&gt;stride()!=1) throw cf3::common::BadValue(FromHere(),&quot;Gid is not of stride==1 for commpattern: &quot; + name());</span></div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;<span class="comment">  if (m_gid-&gt;is_data_type_Uint()!=true) throw cf3::common::CastingFailed(FromHere(),&quot;Gid is not of type Uint for commpattern: &quot; + name());</span></div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;<span class="comment">  Uint* gid=(Uint*)m_gid-&gt;pack();</span></div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;<span class="comment">  m_isUpdatable.resize(m_gid-&gt;size(),true);</span></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;<span class="comment">  // get counts on receive side</span></div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;<span class="comment">  BOOST_FOREACH(temp_buffer_item&amp; i, m_add_buffer) m_recvCount[i.rank]++;</span></div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;<span class="comment">  m_recvCount[irank]=0;</span></div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;<span class="comment">  int recvSum=0;</span></div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;<span class="comment">  BOOST_FOREACH(CPint&amp; i, m_recvCount) recvSum+=i;</span></div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;<span class="comment">  std::vector&lt;CPint&gt; recvcounter(nproc,0);</span></div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;<span class="comment">  for (int i=1; i&lt;nproc; i++) recvcounter[i]=m_recvCount[i-1]+recvcounter[i-1];</span></div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;<span class="comment">  m_recvMap.reserve(recvSum);</span></div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;<span class="comment">  m_recvMap.resize(recvSum);</span></div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;<span class="comment">//PECheckPoint(100,&quot;-- step 1 --:&quot;);</span></div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;<span class="comment">//PEProcessSortedExecute(-1,PEDebugVector(m_recvCount,m_recvCount.size()));</span></div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;<span class="comment">//PEProcessSortedExecute(-1,PEDebugVector(recvcounter,recvcounter.size()));</span></div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;<span class="comment">  // fill receive data and inverse send</span></div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;<span class="comment">  std::vector&lt;CPint&gt; receive_gids(recvSum);</span></div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;<span class="comment">  int lid=0;</span></div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;<span class="comment">  BOOST_FOREACH(temp_buffer_item&amp; i, m_add_buffer)</span></div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;<span class="comment">  {</span></div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;<span class="comment">    if (i.rank!=irank)</span></div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;<span class="comment">    {</span></div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;<span class="comment">      receive_gids[recvcounter[i.rank]]=i.gid;</span></div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;<span class="comment">      m_recvMap[recvcounter[i.rank]]=lid;</span></div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;<span class="comment">      m_isUpdatable[lid]=false;</span></div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;<span class="comment">      recvcounter[i.rank]++;</span></div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;<span class="comment">    }</span></div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;<span class="comment">    lid++;</span></div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;<span class="comment">  }</span></div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;<span class="comment">//PECheckPoint(100,&quot;-- step 2 --:&quot;);</span></div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;<span class="comment">//PEProcessSortedExecute(-1,PEDebugVector(receive_gids,receive_gids.size()));</span></div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;<span class="comment">//PEProcessSortedExecute(-1,PEDebugVector(m_recvMap,m_recvMap.size()));</span></div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;<span class="comment">  // communicate gids per receive side</span></div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;<span class="comment">  m_sendMap.resize(0);</span></div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;<span class="comment">  m_sendMap.reserve(0);</span></div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;<span class="comment">  m_sendCount.assign(nproc,-1);</span></div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;<span class="comment">  PE::Comm::instance().all_to_all(receive_gids,m_recvCount,m_sendMap,m_sendCount);</span></div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;<span class="comment">//PECheckPoint(100,&quot;-- step 3 --:&quot;);</span></div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;<span class="comment">//PEProcessSortedExecute(-1,PEDebugVector(m_sendCount,m_sendCount.size()));</span></div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;<span class="comment">//PEProcessSortedExecute(-1,PEDebugVector(m_sendMap,m_sendMap.size()));</span></div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;<span class="comment">  // Reverse GID mapping</span></div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;<span class="comment">  typedef std::map&lt;Uint, Uint&gt; GidMapT;</span></div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;<span class="comment">  GidMapT gid_reverse;</span></div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;<span class="comment">  const int gid_count = m_gid-&gt;size();</span></div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;<span class="comment">  for(int i=0; i&lt;gid_count; i++)</span></div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;<span class="comment">    gid_reverse[gid[i]] = i;</span></div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;<span class="comment">  BOOST_FOREACH(int&amp; si, m_sendMap)</span></div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;<span class="comment">  {</span></div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;<span class="comment">    bool found = false;</span></div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;<span class="comment">    GidMapT::const_iterator match = gid_reverse.find(si);</span></div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;<span class="comment">    if(match != gid_reverse.end())</span></div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;<span class="comment">      si = match-&gt;second;</span></div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;<span class="comment">    else</span></div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;<span class="comment">      throw ValueNotFound(FromHere(), &quot;requested global id &quot; + to_str(si) + &quot; not found in gid list&quot; );</span></div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;<span class="comment">  }</span></div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;<span class="comment">//PECheckPoint(100,&quot;-- step 4 --:&quot;);</span></div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;<span class="comment">//PEProcessSortedExecute(-1,PEDebugVector(m_sendMap,m_sendMap.size()));</span></div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;<span class="comment">}</span></div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;<span class="comment">/*/</span></div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;<span class="comment">void CommPattern::synchronize_all()</span></div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;<span class="comment">{</span></div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;<span class="comment">  std::vector&lt;unsigned char&gt; sndbuf(1);</span></div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;<span class="comment">  std::vector&lt;unsigned char&gt; rcvbuf(1);</span></div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;<span class="comment">  BOOST_FOREACH( CommWrapper&amp; pobj, find_components_recursively&lt;CommWrapper&gt;(*this) )</span></div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;<span class="comment">  {</span></div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;<span class="comment">    synchronize_this(pobj,sndbuf,rcvbuf);</span></div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;<span class="comment">  }</span></div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;<span class="comment">}</span></div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;<span class="comment">void CommPattern::synchronize( const std::string&amp; name )</span></div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;<span class="comment">{</span></div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;<span class="comment">  std::vector&lt;unsigned char&gt; sndbuf(1);</span></div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;<span class="comment">  std::vector&lt;unsigned char&gt; rcvbuf(1);</span></div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;<span class="comment">  Handle&lt;CommWrapper&gt; pobj(get_child(name));</span></div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;<span class="comment">  synchronize_this(*pobj,sndbuf,rcvbuf);</span></div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;<span class="comment">}</span></div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;<span class="comment">void CommPattern::synchronize( const CommWrapper&amp; pobj )</span></div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;<span class="comment">{</span></div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;<span class="comment">  std::vector&lt;unsigned char&gt; sndbuf(1);</span></div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;<span class="comment">  std::vector&lt;unsigned char&gt; rcvbuf(1);</span></div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;<span class="comment">  synchronize_this(pobj,sndbuf,rcvbuf);</span></div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;<span class="comment">}</span></div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;<span class="comment">// having the vectors for the intermediate buf coming from outside allows keeping them and reuse for all synchronize</span></div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;<span class="comment">void CommPattern::synchronize_this( const CommWrapper&amp; pobj, std::vector&lt;unsigned char&gt;&amp; sndbuf, std::vector&lt;unsigned char&gt;&amp; rcvbuf )</span></div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;<span class="comment">{</span></div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;<span class="comment">//  std::cout &lt;&lt; PERank &lt;&lt; pobj.name() &lt;&lt; &quot;\n&quot; &lt;&lt; std::flush;</span></div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;<span class="comment">//  std::cout &lt;&lt; PERank &lt;&lt; pobj.needs_update() &lt;&lt; &quot;\n&quot; &lt;&lt; std::flush;</span></div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;<span class="comment">  if ( pobj.needs_update() )</span></div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;<span class="comment">  {</span></div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;<span class="comment">    pobj.pack(sndbuf,m_sendMap);</span></div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;<span class="comment">    rcvbuf.resize(m_recvMap.size()*pobj.size_of()*pobj.stride());</span></div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;<span class="comment">    PE::Comm::instance().all_to_all(sndbuf,m_sendCount,rcvbuf,m_recvCount,pobj.size_of()*pobj.stride());</span></div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;<span class="comment">    pobj.unpack(rcvbuf,m_recvMap);</span></div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;<span class="comment">  }</span></div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;<span class="comment">}</span></div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;<span class="comment">void CommPattern::add_global(Uint gid, Uint rank)</span></div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;<span class="comment">{</span></div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;<span class="comment">  // later a mechanism could be implemented when commpattern can give gids by calling a &quot;reserve(int num)&quot; beforehand, to optimize performance</span></div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;<span class="comment">  // submits NEGATIVE lid&#39;s to distuingish add_global and add_local</span></div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;<span class="comment">  if (m_isFreeze) throw common::ShouldNotBeHere(FromHere(),&quot;Wanted to add nodes to commpattern &#39;&quot; + name() + &quot;&#39; which is freezed.&quot;);</span></div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;<span class="comment">  int next_lid=m_free_lids.back();</span></div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;<span class="comment">  if (m_free_lids.size()&gt;1) m_free_lids.pop_back();</span></div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;<span class="comment">  else m_free_lids[0]=next_lid+1;</span></div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;<span class="comment">  m_add_buffer.push_back(temp_buffer_item(-next_lid,gid,rank,(rank==PE::Comm::instance().rank())));</span></div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;<span class="comment">  m_isUpToDate=false;</span></div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;<span class="comment">}</span></div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;<span class="comment">Uint CommPattern::add_local(bool as_ghost)</span></div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;<span class="comment">{</span></div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;<span class="comment">  if (m_isFreeze) throw common::ShouldNotBeHere(FromHere(),&quot;Wanted to add nodes to commpattern &#39;&quot; + name() + &quot;&#39; which is freezed.&quot;);</span></div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;<span class="comment">  int next_lid=m_free_lids.back();</span></div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;<span class="comment">  if (m_free_lids.size()&gt;1) m_free_lids.pop_back();</span></div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;<span class="comment">  else m_free_lids[0]=next_lid+1;</span></div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;<span class="comment">  m_add_buffer.push_back(temp_buffer_item(next_lid,std::numeric_limits&lt;Uint&gt;::max(),PE::Comm::instance().rank(),as_ghost));</span></div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;<span class="comment">  m_isUpToDate=false;</span></div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;<span class="comment">  return next_lid;</span></div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;<span class="comment">}</span></div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;<span class="comment">void CommPattern::move_local(Uint lid, Uint rank, bool keep_as_ghost)</span></div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;<span class="comment">{</span></div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;<span class="comment">  if (m_isFreeze) throw common::ShouldNotBeHere(FromHere(),&quot;Wanted to moves nodes of commpattern &#39;&quot; + name() + &quot;&#39; which is freezed.&quot;);</span></div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;<span class="comment">  m_mov_buffer.push_back(temp_buffer_item(lid,std::numeric_limits&lt;Uint&gt;::max(),rank,keep_as_ghost));</span></div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;<span class="comment">  if (!keep_as_ghost) m_free_lids.push_back(lid);</span></div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;<span class="comment">  m_isUpToDate=false;</span></div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;<span class="comment">}</span></div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;<span class="comment">void CommPattern::remove_local(Uint lid, bool on_all_ranks)</span></div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;<span class="comment">{</span></div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;<span class="comment">  if (m_isFreeze) throw common::ShouldNotBeHere(FromHere(),&quot;Wanted to delete nodes from commpattern &#39;&quot; + name() + &quot;&#39; which is freezed.&quot;);</span></div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;<span class="comment">  m_rem_buffer.push_back(temp_buffer_item(lid,std::numeric_limits&lt;Uint&gt;::max(),PE::Comm::instance().rank(),on_all_ranks));</span></div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;<span class="comment">  m_free_lids.push_back(lid);</span></div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;<span class="comment">  m_isUpToDate=false;</span></div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;<span class="comment">}</span></div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;<span class="comment">// Component related</span></div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;<span class="comment">} // PE</span></div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;<span class="comment">} // common</span></div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;<span class="comment">} // cf3</span></div>
<div class="ttc" id="classcf3_1_1common_1_1_p_e_1_1_comm_pattern_html_aebe049d4c5f8ea80a77a9dd52a1ac311"><div class="ttname"><a href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#aebe049d4c5f8ea80a77a9dd52a1ac311">cf3::common::PE::CommPattern::m_gid</a></div><div class="ttdeci">Handle&lt; CommWrapper &gt; m_gid</div><div class="ttdoc">explicit shared_ptr to the gid wrapper </div><div class="ttdef"><b>Definition:</b> <a href="_comm_pattern_8hpp_source.html#l00332">CommPattern.hpp:332</a></div></div>
<div class="ttc" id="namespacecf3_1_1python_html_a67907f0a2a4e9a684772d2d7b165a5ae"><div class="ttname"><a href="namespacecf3_1_1python.html#a67907f0a2a4e9a684772d2d7b165a5ae">cf3::python::name</a></div><div class="ttdeci">std::string name(ComponentWrapper &amp;self)</div><div class="ttdef"><b>Definition:</b> <a href="_component_wrapper_8cpp_source.html#l00340">ComponentWrapper.cpp:340</a></div></div>
<div class="ttc" id="namespaceboost_html"><div class="ttname"><a href="namespaceboost.html">boost</a></div><div class="ttdoc">external boost library namespace </div><div class="ttdef"><b>Definition:</b> <a href="_boost_assertions_8cpp_source.html#l00012">BoostAssertions.cpp:12</a></div></div>
<div class="ttc" id="_comm_pattern_8hpp_html"><div class="ttname"><a href="_comm_pattern_8hpp.html">CommPattern.hpp</a></div><div class="ttdoc">Parallel Communication Pattern. This class provides functionality to collect communication. For efficiency it works such a way that you submit your request via the constructor or the add/remove/move magic triangle and then call setup to modify the commpattern. The data needed to be kept synchronous can be registered via the insert function. The word node here means any kind of "point of storage", in this context it is not directly related with the computational mesh. </div></div>
<div class="ttc" id="classcf3_1_1common_1_1_component_html_a7a36979ddbbee784d3add3d8f518b9f2"><div class="ttname"><a href="classcf3_1_1common_1_1_component.html#a7a36979ddbbee784d3add3d8f518b9f2">cf3::common::Component::begin</a></div><div class="ttdeci">Component::iterator begin()</div><div class="ttdoc">The begin iterator for a range containing Components. </div><div class="ttdef"><b>Definition:</b> <a href="_component_8cpp_source.html#l01318">Component.cpp:1318</a></div></div>
<div class="ttc" id="namespacestd_html"><div class="ttname"><a href="namespacestd.html">std</a></div><div class="ttdoc">STL namespace. </div></div>
<div class="ttc" id="classcf3_1_1common_1_1_p_e_1_1_comm_pattern_html_af8d3e3e8d930cffe932453524a407707"><div class="ttname"><a href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#af8d3e3e8d930cffe932453524a407707">cf3::common::PE::CommPattern::CommPattern</a></div><div class="ttdeci">CommPattern(const std::string &amp;name)</div></div>
<div class="ttc" id="_builder_8hpp_html"><div class="ttname"><a href="_builder_8hpp.html">Builder.hpp</a></div></div>
<div class="ttc" id="structcf3_1_1common_1_1_bad_value_html"><div class="ttname"><a href="structcf3_1_1common_1_1_bad_value.html">cf3::common::BadValue</a></div><div class="ttdef"><b>Definition:</b> <a href="_basic_exceptions_8hpp_source.html#l00036">BasicExceptions.hpp:36</a></div></div>
<div class="ttc" id="classcf3_1_1common_1_1_component_html_a324e8c54c4c5161913681a1a52fef959"><div class="ttname"><a href="classcf3_1_1common_1_1_component.html#a324e8c54c4c5161913681a1a52fef959">cf3::common::Component::name</a></div><div class="ttdeci">const std::string &amp; name() const </div><div class="ttdoc">Access the name of the component. </div><div class="ttdef"><b>Definition:</b> <a href="_component_8hpp_source.html#l00146">Component.hpp:146</a></div></div>
<div class="ttc" id="classcf3_1_1common_1_1_p_e_1_1_comm_pattern_html_a1541d04226428ccf0b5bf9741b31aa8e"><div class="ttname"><a href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#a1541d04226428ccf0b5bf9741b31aa8e">cf3::common::PE::CommPattern::m_free_lids</a></div><div class="ttdeci">std::vector&lt; Uint &gt; m_free_lids</div><div class="ttdoc">temporary buffer storing the available local ids, which are scattered inside the already existing dat...</div><div class="ttdef"><b>Definition:</b> <a href="_comm_pattern_8hpp_source.html#l00327">CommPattern.hpp:327</a></div></div>
<div class="ttc" id="classcf3_1_1common_1_1_component_html_ac54e76afbf245efdd30b205dcb940f8a"><div class="ttname"><a href="classcf3_1_1common_1_1_component.html#ac54e76afbf245efdd30b205dcb940f8a">cf3::common::Component::iterator</a></div><div class="ttdeci">ComponentIterator&lt; Component &gt; iterator</div><div class="ttdoc">type of the iterator to Component </div><div class="ttdef"><b>Definition:</b> <a href="_component_8hpp_source.html#l00092">Component.hpp:92</a></div></div>
<div class="ttc" id="classcf3_1_1common_1_1_p_e_1_1_comm_pattern_html_a9a1ac3099ec7e8ef3765db67153c8969"><div class="ttname"><a href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#a9a1ac3099ec7e8ef3765db67153c8969">cf3::common::PE::CommPattern::m_ranks</a></div><div class="ttdeci">std::vector&lt; int &gt; m_ranks</div><div class="ttdoc">Rank for all the gids in local index space. </div><div class="ttdef"><b>Definition:</b> <a href="_comm_pattern_8hpp_source.html#l00350">CommPattern.hpp:350</a></div></div>
<div class="ttc" id="classcf3_1_1common_1_1_p_e_1_1_comm_pattern_html_a982606de355f2bc9ffd987fcb317276e"><div class="ttname"><a href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#a982606de355f2bc9ffd987fcb317276e">cf3::common::PE::CommPattern::m_isUpdatable</a></div><div class="ttdeci">std::vector&lt; bool &gt; m_isUpdatable</div><div class="ttdoc">array holding the updatable info </div><div class="ttdef"><b>Definition:</b> <a href="_comm_pattern_8hpp_source.html#l00335">CommPattern.hpp:335</a></div></div>
<div class="ttc" id="_find_components_8hpp_html"><div class="ttname"><a href="_find_components_8hpp.html">FindComponents.hpp</a></div></div>
<div class="ttc" id="structcf3_1_1common_1_1_casting_failed_html"><div class="ttname"><a href="structcf3_1_1common_1_1_casting_failed.html">cf3::common::CastingFailed</a></div><div class="ttdef"><b>Definition:</b> <a href="_basic_exceptions_8hpp_source.html#l00049">BasicExceptions.hpp:49</a></div></div>
<div class="ttc" id="namespacecf3_html"><div class="ttname"><a href="namespacecf3.html">cf3</a></div><div class="ttdoc">Top-level namespace for coolfluid. </div><div class="ttdef"><b>Definition:</b> <a href="common_2_action_8cpp_source.html#l00018">Action.cpp:18</a></div></div>
<div class="ttc" id="_boost_assertions_8hpp_html"><div class="ttname"><a href="_boost_assertions_8hpp.html">BoostAssertions.hpp</a></div></div>
<div class="ttc" id="debug_8hpp_html"><div class="ttname"><a href="debug_8hpp.html">debug.hpp</a></div></div>
<div class="ttc" id="namespacecf3_html_a4840c4503b7d10cea5e08416eb3716f1"><div class="ttname"><a href="namespacecf3.html#a4840c4503b7d10cea5e08416eb3716f1">cf3::Uint</a></div><div class="ttdeci">unsigned int Uint</div><div class="ttdoc">typedef for unsigned int </div><div class="ttdef"><b>Definition:</b> <a href="_c_f_8hpp_source.html#l00090">CF.hpp:90</a></div></div>
<div class="ttc" id="_comm_wrapper_8hpp_html"><div class="ttname"><a href="_comm_wrapper_8hpp.html">CommWrapper.hpp</a></div></div>
<div class="ttc" id="classcf3_1_1common_1_1_p_e_1_1_comm_pattern_html_aedbe1f2fe33f04a1beb89d474327c078"><div class="ttname"><a href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#aedbe1f2fe33f04a1beb89d474327c078">cf3::common::PE::CommPattern::~CommPattern</a></div><div class="ttdeci">~CommPattern()</div><div class="ttdoc">destructor </div></div>
<div class="ttc" id="_log_8hpp_html"><div class="ttname"><a href="_log_8hpp.html">Log.hpp</a></div></div>
<div class="ttc" id="classcf3_1_1common_1_1_component_html_a9ce1915506b54e15a31a46b6cc8f6368"><div class="ttname"><a href="classcf3_1_1common_1_1_component.html#a9ce1915506b54e15a31a46b6cc8f6368">cf3::common::Component::end</a></div><div class="ttdeci">Component::iterator end()</div><div class="ttdoc">The end iterator for a range containing Components. </div><div class="ttdef"><b>Definition:</b> <a href="_component_8cpp_source.html#l01327">Component.cpp:1327</a></div></div>
<div class="ttc" id="classcf3_1_1common_1_1_p_e_1_1_comm_pattern_html_a4fc01d736fe50cf5b977f755b675f11d"><div class="ttname"><a href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#a4fc01d736fe50cf5b977f755b675f11d">cf3::common::PE::CommPattern::setup</a></div><div class="ttdeci">void setup()</div></div>
<div class="ttc" id="classcf3_1_1common_1_1_p_e_1_1_comm_pattern_html_a560cabf21c45c048c4af07f20ccdf8f2"><div class="ttname"><a href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#a560cabf21c45c048c4af07f20ccdf8f2">cf3::common::PE::CommPattern::add_global</a></div><div class="ttdeci">void add_global(Uint gid, Uint rank)</div></div>
<div class="ttc" id="_lib_common_8hpp_html"><div class="ttname"><a href="_lib_common_8hpp.html">LibCommon.hpp</a></div></div>
<div class="ttc" id="utest-mesh-dictionary_8cpp_html_a9f6c37b0b11a193703cacdeb5c3e3f6b"><div class="ttname"><a href="utest-mesh-dictionary_8cpp.html#a9f6c37b0b11a193703cacdeb5c3e3f6b">map</a></div><div class="ttdeci">void map(Field &amp;field, Eigen::Map&lt; Derived &gt; &amp;v, const Uint row_idx, const Uint var_idx)</div><div class="ttdef"><b>Definition:</b> <a href="utest-mesh-dictionary_8cpp_source.html#l00063">utest-mesh-dictionary.cpp:63</a></div></div>
<div class="ttc" id="namespacecf3_1_1common_html_a9e2779a644fde7b30a3a14b0775a66fe"><div class="ttname"><a href="namespacecf3_1_1common.html#a9e2779a644fde7b30a3a14b0775a66fe">cf3::common::allocate_component</a></div><div class="ttdeci">boost::shared_ptr&lt; T &gt; allocate_component(const std::string &amp;name)</div><div class="ttdoc">Stand-alone function to allocate components of a given type. </div><div class="ttdef"><b>Definition:</b> <a href="_component_8hpp_source.html#l00055">Component.hpp:55</a></div></div>
<div class="ttc" id="_comm_8hpp_html"><div class="ttname"><a href="_comm_8hpp.html">Comm.hpp</a></div></div>
<div class="ttc" id="classcf3_1_1common_1_1_p_e_1_1_comm_pattern_html_acf08aef8ff8a70c632af627dc381777c"><div class="ttname"><a href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#acf08aef8ff8a70c632af627dc381777c">cf3::common::PE::CommPattern::m_isUpToDate</a></div><div class="ttdeci">bool m_isUpToDate</div><div class="ttdoc">flag telling if communication pattern is up-to-date (there are no items ) </div><div class="ttdef"><b>Definition:</b> <a href="_comm_pattern_8hpp_source.html#l00304">CommPattern.hpp:304</a></div></div>
<div class="ttc" id="classcf3_1_1common_1_1_p_e_1_1_comm_pattern_html_a2ae90dcd92e4a1c700dbdd10b78021f5"><div class="ttname"><a href="classcf3_1_1common_1_1_p_e_1_1_comm_pattern.html#a2ae90dcd92e4a1c700dbdd10b78021f5">cf3::common::PE::CommPattern::gid</a></div><div class="ttdeci">const Handle&lt; CommWrapper &gt; gid() const </div><div class="ttdef"><b>Definition:</b> <a href="_comm_pattern_8hpp_source.html#l00278">CommPattern.hpp:278</a></div></div>
<div class="ttc" id="_code_location_8hpp_html_acc1ba5f90e834dec77544016b6b5619d"><div class="ttname"><a href="_code_location_8hpp.html#acc1ba5f90e834dec77544016b6b5619d">FromHere</a></div><div class="ttdeci">#define FromHere()</div><div class="ttdef"><b>Definition:</b> <a href="_code_location_8hpp_source.html#l00045">CodeLocation.hpp:45</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<hr class="footer"/><address class="footer"><small>
Generated on Sun Jun 14 2015 21:20:10 for COOLFluiD by&nbsp;<a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.9.1</small></address>
<table width="100%">
  <tr>
    <td>
    </td>
    <td align="right" valign="center">
      Send comments to:<br>
      <a href="mailto:coolfluid@vki.ac.be">COOLFluiD Web Admin</a>
    </td>
  </tr>
</table>
</body>
</html>
